# ============================================
# Nginx Location Rules - URL Routing Configuration
# ============================================
# File này định nghĩa cách Nginx route các requests đến backend services
# Pattern: URL path -> Backend service

# ============================================
# API Routes - Proxy đến ASP.NET Core API
# ============================================
# location /api/: Bắt tất cả requests bắt đầu với /api/
# VD: /api/users, /api/auth/login, etc.
location /api/ {
    # ============================================
    # Rate Limiting
    # ============================================
    # limit_req: Áp dụng rate limiting (đã config trong nginx.conf)
    # zone=api: Sử dụng zone "api" (10 req/s)
    # burst=20: Cho phép tối đa 20 requests trong queue
    # nodelay: Không delay các requests trong burst limit
    limit_req zone=api burst=20 nodelay;
    
    # ============================================
    # Proxy Configuration
    # ============================================
    # proxy_pass: Forward request đến backend API
    # http://api_backend: Sử dụng upstream đã định nghĩa
    # /api/: Giữ nguyên path /api/ khi forward
    proxy_pass http://api_backend/api/;
    
    # proxy_http_version 1.1: Sử dụng HTTP/1.1 để support WebSocket
    proxy_http_version 1.1;
    
    # ============================================
    # WebSocket Support Headers
    # ============================================
    # Cần thiết cho SignalR WebSocket connections
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    
    # ============================================
    # Request Headers (Pass client info to backend)
    # ============================================
    # Host: Original host header từ client
    proxy_set_header Host $host;
    
    # X-Real-IP: IP thật của client (không phải IP của Nginx)
    proxy_set_header X-Real-IP $remote_addr;
    
    # X-Forwarded-For: Chain of proxy IPs
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # X-Forwarded-Proto: Original protocol (http/https)
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # proxy_cache_bypass: Bypass cache cho WebSocket connections
    proxy_cache_bypass $http_upgrade;
    
    # proxy_redirect off: Không modify Location headers trong response
    proxy_redirect off;
    
    # ============================================
    # Timeout Configuration
    # ============================================
    # proxy_connect_timeout: Thời gian timeout khi connect đến backend
    proxy_connect_timeout 60s;
    
    # proxy_send_timeout: Timeout khi gửi request đến backend
    proxy_send_timeout 60s;
    
    # proxy_read_timeout: Timeout khi đọc response từ backend
    proxy_read_timeout 60s;
    
    # ============================================
    # Buffer Configuration (Performance)
    # ============================================
    # proxy_buffering on: Bật buffering để improve performance
    proxy_buffering on;
    
    # proxy_buffer_size: Size của buffer đầu tiên (cho headers)
    proxy_buffer_size 8k;
    
    # proxy_buffers: Số lượng và size của buffers cho response body
    proxy_buffers 8 8k;
}

# ============================================
# SignalR Hub - WebSocket Real-time Communication
# ============================================
# location /hubs/: Route cho SignalR WebSocket connections
# VD: /hubs/drawgame cho real-time drawing communication
location /hubs/ {
    # Forward đến API backend
    proxy_pass http://api_backend/hubs/;
    
    # HTTP/1.1 required cho WebSocket
    proxy_http_version 1.1;
    
    # WebSocket headers - CRITICAL cho SignalR
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Bypass cache cho WebSocket
    proxy_cache_bypass $http_upgrade;
    
    # ============================================
    # Extended Timeouts cho SignalR
    # ============================================
    # SignalR connections có thể kéo dài rất lâu (gaming sessions)
    # 300s = 5 minutes timeout
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
}

# ============================================
# Swagger API Documentation (Staging Only)
# ============================================
# location /swagger/: Route cho Swagger UI
# Chỉ enable trong staging để test API, production nên tắt
location /swagger/ {
    # Forward đến API backend Swagger endpoint
    proxy_pass http://api_backend/swagger/;
    
    # Basic proxy setup (không cần WebSocket cho Swagger)
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ============================================
# Static File Uploads từ API (Optional)
# ============================================
# location /uploads/: Route cho uploaded files (images, documents)
# VD: /uploads/avatars/user123.jpg
location /uploads/ {
    # Forward đến API backend để serve uploaded files
    proxy_pass http://api_backend/uploads/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    
    # ============================================
    # Aggressive Caching cho Static Files
    # ============================================
    # expires 30d: Cache 30 ngày ở browser
    expires 30d;
    
    # Cache-Control: Báo browser và CDN cache lâu
    # public: Có thể cache ở shared cache (CDN)
    # immutable: File không bao giờ thay đổi
    add_header Cache-Control "public, immutable";
}

# ============================================
# Next.js Static Assets (CSS, JS, Images)
# ============================================
# location /_next/static/: Next.js build outputs (optimized assets)
# VD: /_next/static/css/app.css, /_next/static/js/main.js
location /_next/static/ {
    # Forward đến frontend container
    proxy_pass http://frontend_backend/_next/static/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    
    # ============================================
    # Long-term Caching cho Build Assets
    # ============================================
    # expires 365d: Cache 1 năm (Next.js tự động thêm hash vào filename)
    expires 365d;
    
    # Immutable cache vì files có hash trong tên
    add_header Cache-Control "public, immutable";
}

# ============================================
# Next.js Internal Routes
# ============================================
# location /_next/: Các routes khác của Next.js framework
# VD: /_next/image, /_next/webpack-hmr (dev mode)
location /_next/ {
    # Forward toàn bộ đến frontend
    proxy_pass http://frontend_backend/_next/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ============================================
# Login Endpoint - Strict Rate Limiting
# ============================================
# Specific route cho login với rate limiting nghiêm ngặt
# Đặt trước /api/ route để có priority cao hơn
location /api/auth/login {
    # ============================================
    # Strict Rate Limiting
    # ============================================
    # zone=login: 1 request/second per IP (rất strict)
    # burst=5: Cho phép 5 requests burst
    # nodelay: Không delay trong burst
    limit_req zone=login burst=5 nodelay;
    
    # Forward đến API với full proxy config
    proxy_pass http://api_backend/api/auth/login;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ============================================
# Frontend Routes - Default Fallback
# ============================================
# location /: Catch-all route cho tất cả requests khác
# Sẽ serve Next.js frontend app (SPA routing)
location / {
    # Forward đến frontend container
    proxy_pass http://frontend_backend/;
    proxy_http_version 1.1;
    
    # Support cho Next.js dynamic content và WebSocket (nếu cần)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # Standard timeouts cho frontend requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
} 